<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>端口转发管理系统 - 登录</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Segoe UI", Roboto, sans-serif;
        }

        /* 全局变量（和管理页保持一致，保证风格统一） */
        :root {
            --primary-color: #165DFF;
            --secondary-color: #36CFC9;
            --light-color: #F5F7FA;
            --dark-color: #1D2129;
            --gray-color: #86909C;
            --white-color: #FFFFFF;
            --danger-color: #F53F3F;
            --success-color: #00B42A;
            --border-radius: 8px;
            --box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease-in-out;
        }

        /* 页面主体样式（全屏居中布局） */
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-image: linear-gradient(120deg, #f0f7ff 0%, #e6f0ff 100%);
        }

        /* 登录卡片（核心容器） */
        .login-card {
            background-color: var(--white-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(22, 93, 255, 0.1);
            padding: 40px 32px;
            width: 100%;
            max-width: 420px;
            transition: var(--transition);
        }

        .login-card:hover {
            box-shadow: 0 8px 30px rgba(22, 93, 255, 0.15);
        }

        /* 登录标题区域 */
        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo {
            font-size: 36px;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--gray-color);
            margin-top: 8px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--dark-color);
            text-align: left;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E8E8E8;
            border-radius: var(--border-radius);
            font-size: 14px;
            color: var(--dark-color);
            transition: var(--transition);
            background-color: var(--light-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
            background-color: var(--white-color);
        }

        .form-input.error {
            border-color: var(--danger-color);
        }

        .error-tip {
            font-size: 12px;
            color: var(--danger-color);
            margin-top: 4px;
            display: none;
        }

        .error-tip.active {
            display: block;
        }

        /* 记住密码 & 忘记密码 */
        .form-helper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            margin-bottom: 24px;
        }

        .remember-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--gray-color);
            cursor: pointer;
        }

        .remember-checkbox input {
            cursor: pointer;
        }

        .forgot-password {
            color: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .forgot-password:hover {
            color: #0E4BD8;
            text-decoration: underline;
        }

        /* 登录按钮 */
        .btn-login {
            width: 100%;
            padding: 12px 0;
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-login:hover {
            background-color: #0E4BD8;
            box-shadow: 0 4px 12px rgba(22, 93, 255, 0.2);
        }

        .btn-login:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* 底部版权信息 */
        .login-footer {
            text-align: center;
            margin-top: 24px;
            font-size: 12px;
            color: var(--gray-color);
        }

        /* 响应式适配（手机端） */
        @media (max-width: 480px) {
            .login-card {
                padding: 32px 24px;
            }

            .login-title {
                font-size: 20px;
            }
        }
    </style>
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="login-card">
        <!-- 登录标题区域 -->
        <div class="login-header">
            <div class="login-logo">
                <i class="fas fa-network-wired"></i>
            </div>
            <div class="login-title">端口转发管理系统</div>
            <div class="login-subtitle">请输入账号密码进行登录</div>
        </div>

        <!-- 登录表单 -->
        <form id="loginForm" autocomplete="on">
            <div class="form-group">
                <label class="form-label" for="username">账号 / 邮箱</label>
                <input type="text" class="form-input" id="username" name="username" autocomplete="username"
                    placeholder="请输入登录账号或邮箱">
                <div class="error-tip" id="usernameError">请输入有效的账号或邮箱</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="password">密码</label>
                <input type="password" class="form-input" id="password" name="password" autocomplete="current-password"
                    placeholder="请输入登录密码">
                <div class="error-tip" id="passwordError">密码不能为空，且长度不少于6位</div>
            </div>

            <div class="form-helper">
                <div class="remember-checkbox">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">记住我（7天内免登录）</label>
                </div>
                <div class="forgot-password" onclick="forgotPasswordTip()">忘记密码？</div>
            </div>

            <button type="submit" class="btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i>
                登录系统
            </button>
        </form>

        <!-- 底部版权 -->
        <div class="login-footer">
            © 2026 端口转发管理系统 - 保留所有权利
        </div>
    </div>

    <script>
        // DOM 元素获取
        const loginForm = document.getElementById("loginForm");
        const username = document.getElementById("username");
        const password = document.getElementById("password");
        const usernameError = document.getElementById("usernameError");
        const passwordError = document.getElementById("passwordError");
        const loginBtn = document.getElementById("loginBtn");

        // 页面加载完成后，给输入框绑定失焦验证事件
        window.onload = function () {
            username.addEventListener("blur", validateUsername);
            password.addEventListener("blur", validatePassword);

            // 从 localStorage 读取保存的用户名并自动填充
            const savedUser = localStorage.getItem("loginUser");
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    // 检查是否在 7 天内
                    const loginTime = userData.loginTime;
                    const now = new Date().getTime();
                    const daysDiff = (now - loginTime) / (1000 * 60 * 60 * 24);

                    if (daysDiff <= 7 && userData.username) {
                        username.value = userData.username;
                        document.getElementById("rememberMe").checked = true;
                    } else {
                        // 超过 7 天，清除保存的数据
                        localStorage.removeItem("loginUser");
                    }
                } catch (e) {
                    localStorage.removeItem("loginUser");
                }
            }
        };

        // 验证账号
        function validateUsername() {
            const value = username.value.trim();
            let isValid = true;

            if (value === "") {
                isValid = false;
                usernameError.textContent = "账号/邮箱不能为空";
            } else if (value.indexOf("@") > -1 && !/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/.test(value)) {
                isValid = false;
                usernameError.textContent = "请输入有效的邮箱格式";
            }

            // 更新样式和错误提示
            username.classList.toggle("error", !isValid);
            usernameError.classList.toggle("active", !isValid);

            return isValid;
        }

        // 验证密码
        function validatePassword() {
            const value = password.value.trim();
            let isValid = true;

            if (value === "") {
                isValid = false;
                passwordError.textContent = "密码不能为空";
            } else if (value.length < 6) {
                isValid = false;
                passwordError.textContent = "密码长度不能少于6位";
            }

            // 更新样式和错误提示
            password.classList.toggle("error", !isValid);
            passwordError.classList.toggle("active", !isValid);

            return isValid;
        }

        // 表单提交事件（核心登录逻辑）
        loginForm.addEventListener("submit", function (e) {
            e.preventDefault(); // 阻止表单默认提交

            // 先执行表单验证
            const isUsernameValid = validateUsername();
            const isPasswordValid = validatePassword();

            if (!isUsernameValid || !isPasswordValid) {
                return; // 验证失败，终止登录
            }

            // 验证通过，调用后端登录 API
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在登录...';

            // 构建登录数据
            const loginData = {
                username: username.value.trim(),
                password: password.value.trim(),
                rememberMe: document.getElementById("rememberMe").checked
            };

            // 发送 AJAX 请求到后端
            fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(loginData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 登录成功
                        alert("登录成功！即将跳转到管理系统首页");

                        // 记住用户名（可选）
                        if (loginData.rememberMe) {
                            localStorage.setItem("loginUser", JSON.stringify({
                                username: loginData.username,
                                loginTime: new Date().getTime()
                            }));
                        } else {
                            localStorage.removeItem("loginUser");
                        }

                        // 跳转到管理页面
                        window.location.href = "/manage";
                    } else {
                        // 登录失败
                        alert("登录失败：" + (data.error || "未知错误"));
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登录系统';
                    }
                })
                .catch(error => {
                    // 网络错误
                    alert("网络错误：" + error.message);
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登录系统';
                });
        });

        // 忘记密码提示
        function forgotPasswordTip() {
            alert("请联系系统管理员重置密码，或通过注册邮箱找回密码！");
        }
    </script>
</body>

</html>